$(document).ready(() => {
	// runs on Enter key keypress
	$("#login-form").keypress((event) => {
		// 13 - key code for Enter
		if (event.which === 13) {
			check_login();
		}
	});
});

function show_password() {
	let input_password = document.querySelector("#input-password");
	if (input_password.type === "password") {
		input_password.type = "text";
	} else {
		input_password.type = "password";
	}
}

/**
 * It sends the data from the login form to the server, and if the server responds with a status of
 * "error", it displays the error message. Otherwise, it calls the login_validated function
 */
function check_login() {
	$.ajax({
		url: "check-login",
		data: $("#login-form").serialize(),
		type: "post",
		dataType: "json",
		beforeSend: function () {
			$("#btnLoginText").html("CHECKING...");
		},
		success: function (response) {
			const { status, message, username, password } = response;
			const input_username = document.querySelector("#input-username");
			const input_password = document.querySelector("#input-password");
			if (status == "error") {
				toastr.options = {
					closeButton: true,
					preventDuplicates: true,
					positionClass: "toast-top-right",
				};
				input_username.value = username;
				input_password.value = password;
				input_username.classList.add("invalid-input", "text-danger");
				input_password.classList.add("invalid-input", "text-danger");
				toastr["error"](message);
				$("#btnLoginText").html("LOG IN");
			} else {
				const {
					token,
					user_id,
					emp_id,
					fullname,
					dsg_hcare_prov,
					doctor_id,
					user_role,
					logged_in,
					next_route,
					next_page,
				} = response;

				login_validated(
					token,
					user_id,
					emp_id,
					fullname,
					user_role,
					dsg_hcare_prov,
					doctor_id,
					logged_in,
					next_route,
					next_page
				);
			}
		},
	});
}

/**
 * It takes in the parameters and sends it to the server via AJAX
 * @param token - the token generated by the server
 * @param user_id - The user's ID
 * @param emp_id - employee id
 * @param fullname - The full name of the user
 * @param dsg_hcare_prov - This is the designation of the user.
 * @param user_role - the role of the user
 * @param logged_in - true or false
 * @param next_route - the route where the ajax request will be sent to
 * @param next_page - the page to be redirected to after login
 */
function login_validated(
	token,
	user_id,
	emp_id,
	fullname,
	user_role,
	dsg_hcare_prov,
	doctor_id,
	logged_in,
	next_route,
	next_page
) {
	const loader = "<?php echo base_url(); ?>assets/images/loader.gif";
	$.ajax({
		url: next_route,
		data: {
			token,
			user_id,
			emp_id,
			fullname,
			user_role,
			dsg_hcare_prov,
			doctor_id,
			logged_in,
		},
		type: "post",
		dataType: "json",
		success: function (response) {
			console.log(response);
			const { status, message } = response;
			if (status == "success") {
				$("#loaderGif").removeClass("d-none");
				$("#loaderGif").show();
				$("#btnLoginText").html("LOGGING IN...");
				setTimeout(function () {
					window.location.href = next_page;
				}, 2500);
			} else {
				toastr.options = {
					closeButton: true,
					preventDuplicates: true,
				};
				toastr["error"](message);
				$("#btnLoginText").html("LOG IN");
			}
		},
	});
}
